# Add Batch column if absent
if (!"Batch" %in% colnames(metadata)) {
metadata$Batch <- 1
log_warn(sample = "",
step   = "prepare_deseq2_input",
msg    = "No 'Batch' column found. Assigning default value '1'.")
}
# Extract variables from formula (e.g., ~Condition + Batch -> c("Condition", "Batch"))
design_formula <- if (grepl("^~", design)) {
as.formula(design)
} else {
as.formula(paste0("~", design))
}
design_vars <- all.vars(design_formula)
missing_vars <- setdiff(design_vars, colnames(metadata))
if (length(missing_vars) > 0) {
log_error(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Design variable(s) not found in metadata: '{paste(missing_vars, collapse = ', ')}'"))
}
# Identify samples with NA in the design columns
na_idx <- apply(X = metadata[, design_vars, drop = FALSE],
MARGIN = 1,
FUN = function(x) any(is.na(x)))
# Only subset metadata if there are any NAs
if (any(na_idx)) {
na_samples <- rownames(metadata)[na_idx]
log_warn(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Removing {length(na_samples)} samples with NA in design columns: {paste(na_samples, collapse = ', ')}"))
metadata <- metadata[!na_idx, , drop = FALSE]
}
# ---- ðŸ§® Expression Matrix Cleaning & Filtering ----
# Convert column names to valid R names
colnames(expr_mat) <- make.names(colnames(expr_mat))
# Retain ONLY samples in metadata for accurate zero count calculations
expr_mat <- expr_mat[, intersect(colnames(expr_mat), rownames(metadata)), drop = FALSE]
# Remove rows with NA gene names
na_rows <- is.na(rownames(expr_mat))
expr_mat <- expr_mat[!na_rows, , drop = FALSE]
log_info(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Removed {sum(na_rows)} rows with missing gene names."))
# Replace missing counts with 0
expr_mat[is.na(expr_mat)] <- 0
# Convert all columns to numeric safely
expr_mat <- matrix(as.numeric(as.matrix(expr_mat)),
nrow = nrow(expr_mat),
ncol = ncol(expr_mat),
dimnames = dimnames(expr_mat))
if (any(is.na(expr_mat))) {
log_error(sample = "",
step   = "plot_heatmap",
msg    = "`expr_mat` contains non-numeric values that could not be converted.")
}
# Remove genes with zero counts across all samples
zero_genes   <- rownames(expr_mat)[which(rowSums(expr_mat) == 0)]
expr_mat <- expr_mat[rowSums(expr_mat) != 0, , drop = FALSE]
log_warn(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Removed {length(zero_genes)} genes with zero counts across all samples."))
# Remove samples with zero total reads
zero_samples <- colnames(expr_mat)[which(colSums(expr_mat) == 0)]
expr_mat <- expr_mat[, colSums(expr_mat) != 0, drop = FALSE]
log_warn(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Removed {length(zero_samples)} samples with zero total counts."))
# ---- ðŸ§© Final Data Structuring for DESeq2 ----
# Synchronize samples between expr_mat and metadata
common_samples <- intersect(colnames(expr_mat), rownames(metadata))
expr_mat <- expr_mat[              , common_samples, drop = FALSE]
metadata <- metadata[common_samples,               , drop = FALSE]
if (length(common_samples) == 0) {
log_error(sample = "",
step   = "prepare_deseq2_input",
msg    = "No overlapping samples between expr_mat and metadata.")
}
# Convert all metadata to factors for DESeq2 compatibility
message("Structure of metadata before conversion:")
str(metadata)
#metadata <- as.data.frame(unclass(metadata), stringsAsFactors = TRUE)
metadata[] <- lapply(metadata, as.factor)
message("Structure of metadata after conversion:")
str(metadata)
# Reset expr_mat to null
if (!is.null(txi)){
expr_mat <- NULL
}
# ---- ðŸªµ Log Output and Return Cleaned Data ----
if (!is.null(expr_mat)) {
n_genes   <- nrow(expr_mat)
n_samples <- ncol(expr_mat)
} else if (!is.null(txi) && !is.null(txi$counts)) {
n_genes   <- nrow(txi$counts)
n_samples <- ncol(txi$counts)
} else {
log_error(sample = "",
step   = "prepare_deseq2_input",
msg    = "Both expr_mat and txi$counts are NULL. Cannot determine genes or samples.")
}
log_info(sample = "",
step   = "prepare_deseq2_input",
msg    = glue::glue("Successfully prepared DESeq2 input: {n_genes} genes and {n_samples} samples."))
return(invisible(list(metadata = metadata, expr_mat = expr_mat, txi = txi)))
}
salmon_dir <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/salmon"
proj_dir <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi"
txi <- prep_txi(salmon_dir = salmon_dir,
species    = "Homo sapiens",
db_version = "113",
filename   = NULL,
output_dir = proj_dir)
metadata <- openxlsx::read.xlsx(file.path(proj_dir, "Xinyi_Metadata.xlsx"))
raw_counts_mat <- NULL
design      <- "Batch"
deseq2_data <- prepare_deseq2_input(expr_mat = raw_counts_mat,
txi      = txi,
metadata = metadata,
design   = design)
dds <- DESeqDataSetFromTximport(txi     = deseq2_data$txi,
colData = deseq2_data$metadata,
design  = ~ Batch)
dds <- DESeq(dds)
vsd <- vst(dds, blind = FALSE)
vsd_mat <- assay(vsd)
library(limma)
vsd_batch_corrected <- removeBatchEffect(vsd_mat,
batch = deseq2_data$metadata$Batch)
ann_list <- get_annotations()
vsd_batch_corrected <- vsd_batch_corrected %>%
as.data.frame() %>%
tibble::rownames_to_column("ID") %>%
add_annotation(ann_list = ann_list) %>%
dplyr::group_by(SYMBOL) %>%
dplyr::summarize(across(.cols = where(is.numeric), .fns = mean, na.rm = TRUE), .groups = "drop") %>%
tibble::column_to_rownames("SYMBOL") %>%
as.matrix()
cl <- getConsensusClass(x = vsd_batch_corrected, gene_id = c("hgnc_symbol"))
remotes::install_github("cit-bioinfo/BLCAsubtyping", build_vignettes = TRUE)
library(BLCAsubtyping)
remotes::install_github("cit-bioinfo/consensusMIBC", build_vignettes = TRUE)
library(consensusMIBC)
cl <- getConsensusClass(x = vsd_batch_corrected, gene_id = c("hgnc_symbol"))
metadata_col <- dplyr::left_join(x = metadata %>% dplyr::mutate(Sample_ID = make.names(Sample_ID)),
y = cl %>% tibble::rownames_to_column("Sample_ID"),
by = c("Sample_ID" = "Sample_ID"))
mat <- vsd_batch_corrected[rownames(vsd_batch_corrected) %in% c(c3_genes, scaffold_genes, cam_genes, ne_genes), ]
c3_genes <- c("CADM2", "CDH12", "CNTNAP2", "CSMD1", "CSMD3", "CTNNA2", "CTNNA3",
"DLG2", "DMD", "DPP10", "EYS", "GRID2", "LINGO1", "NRG1", "PCDH15",
"PTPRD", "RASGEF1B", "RBFOX1", "SLC26A3", "TMEM132D")
scaffold_genes <- c("DLG2", "DLG4", "HOMER1", "HOMER2", "HOMER3", "SHANK1",
"SHANK2", "SHANK3")
cam_genes <- c("CDH2", "CDH12", "LRFN1", "DAG1", "NLGN1", "NLGN2", "NLGN3",
"LRRTM1", "LRRTM2", "ADGRL2", "ADGRL3", "EPHB2", "EPHB3",
"ADGRB1", "ADGRB3") #"NRXN1", "NRXN2", "NRXN3",
ne_genes <- c("MSI1", "PLEKHG4B", "GNG4", "PEG10", "RND2", "APLP1", "SOX2",
"TUBB2B", "CHGA", "CHGB", "NCAM1", "SYP")
combo <- c(cam_genes, scaffold_genes)
cl <- getConsensusClass(x = vsd_batch_corrected, gene_id = c("hgnc_symbol"))
metadata_col <- dplyr::left_join(x = metadata %>% dplyr::mutate(Sample_ID = make.names(Sample_ID)),
y = cl %>% tibble::rownames_to_column("Sample_ID"),
by = c("Sample_ID" = "Sample_ID"))
mat <- vsd_batch_corrected[rownames(vsd_batch_corrected) %in% c(c3_genes, scaffold_genes, cam_genes, ne_genes), ]
ph <- plot_heatmap(expr_mat            = mat,
label_genes         =  metadata_row$SYMBOL,
filename            = "Xinyi",
output_dir          = proj_dir,
metadata_col        = metadata_col,
metadata_row        = metadata_row,
col_annotations     = c("consensusClass"),
row_annotations     = c("Category"),
col_gap_by          = c("consensusClass"),
row_gap_by          = c("Category"),
col_cluster_by      = c("consensusClass"),
row_cluster_by      = c("Category"),
plot_title          = NULL,
heatmap_palette     = "rdbu",
annotation_palette  = "discrete",
border_color        = NA,
force_log           = FALSE,
show_expr_legend    = TRUE,
save_plot           = TRUE,
save_matrix         = TRUE)
View(cl)
df_c3 <- data.frame(SYMBOL = c3_genes, Category = "C3")
df_scaffold <- data.frame(SYMBOL = scaffold_genes, Category = "Scaffold")
df_cam <- data.frame(SYMBOL = cam_genes, Category = "CAM")
df_ne <- data.frame(SYMBOL = ne_genes, Category = "Neuroendocrine")
metadata_row <- rbind(df_c3, df_scaffold, df_cam, df_ne) %>%
dplyr::distinct(SYMBOL, .keep_all = TRUE)
mat <- vsd_batch_corrected[rownames(vsd_batch_corrected) %in% c(c3_genes, scaffold_genes, cam_genes, ne_genes), ]
ph <- plot_heatmap(expr_mat            = mat,
label_genes         =  metadata_row$SYMBOL,
filename            = "Xinyi",
output_dir          = proj_dir,
metadata_col        = metadata_col,
metadata_row        = metadata_row,
col_annotations     = c("consensusClass"),
row_annotations     = c("Category"),
col_gap_by          = c("consensusClass"),
row_gap_by          = c("Category"),
col_cluster_by      = c("consensusClass"),
row_cluster_by      = c("Category"),
plot_title          = NULL,
heatmap_palette     = "rdbu",
annotation_palette  = "discrete",
border_color        = NA,
force_log           = FALSE,
show_expr_legend    = TRUE,
save_plot           = TRUE,
save_matrix         = TRUE)
# Save the results
wb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wb, sheetName = "Classification")
openxlsx::writeData(wb, sheet = "Classification", x = metadata_col)
openxlsx::saveWorkbook(wb, file = file.path(proj_dir,"Classification.xlsx"), overwrite = TRUE)
wb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wb, sheetName = "VST counts")
openxlsx::writeData(wb, sheet = "VST counts", x = vsd_batch_corrected)
openxlsx::saveWorkbook(wb, file = file.path(proj_dir,"Batch corrected VST counts.xlsx"), overwrite = TRUE)
View(vsd_batch_corrected)
wb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wb, sheetName = "VST counts")
openxlsx::writeData(wb, sheet = "VST counts", x = vsd_batch_corrected, rowNames = TRUE)
openxlsx::saveWorkbook(wb, file = file.path(proj_dir,"Batch corrected VST counts.xlsx"), overwrite = TRUE)
# Load the two objects
txi_run1 <- readRDS(""C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/txi.rds")
# Load the two objects
txi_run1 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/txi.rds")
# Load the two objects
txi_run1 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/txi.rds")
txi_run2 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/salmon_old/old/txi.rds")
# 1. Check if the Gene IDs and Samples match exactly
identical_structure <- identical(rownames(txi_run1$counts), rownames(txi_run2$counts)) &&
identical(colnames(txi_run1$counts), colnames(txi_run2$counts))
if(!identical_structure) {
stop("The two TXI objects have different genes or samples!")
}
colnames(txi_run2$counts)
colnames(txi_run1$counts)
# 1. Create the mapping based on your image
# Left side is the "Hbca" name, right side is the ID found in run2
id_map <- c(
"Hbca01" = "L1MKI1007695.A1417245", "Hbca02" = "L1MKI1007696.A1359551",
"Hbca03" = "L1MKI1007697.A1179330", "Hbca04" = "L1MKI1007698.A1392252",
"Hbca05" = "L1MKI1007700.A1572261", "Hbca06" = "L1MKI1007701.A1615467",
"Hbca07" = "L1MKI1007710.A2514790", "Hbca08" = "L1MKI1007711.A2508198",
"Hbca09" = "L1MKI1007712.A2512442", "Hbca10" = "L1MKI1007713.A2510803",
"Hbca11" = "L1MKI1007714.A2524699", "Hbca12" = "L1MKI1007716.A2507863",
"Hbca13" = "L1MKI1007717.A2510884", "Hbca14" = "L1MKI1007718.A2508524",
"Hbca15" = "L1MKI1007719.A2511623", "Hbca16" = "L1MKI1007720.A2510947",
"Hbca17" = "L1MKI1007721.A2507839", "Hbca18" = "L1MKI1007722.A2514836",
"Hbca19" = "L1MKI1007725.A2515727", "Hbca20" = "L1MKI1007726.A2510069",
"Hbca21" = "L1MKI1007727.A2515099", "Hbca22" = "L1MKI1007728.A2527491",
"Hbca23" = "L1MKI1007729.A2507738", "Hbca24" = "L1MKK1901578.A3",
"Hbca25" = "L1MKK1901580.A5",       "Hbca26" = "L1MKK1901582.A7",
"Hbca27" = "L1MKK1901583.A8",       "Hbca28" = "L1MKK1901584.A9",
"Hbca29" = "L1MKK1901585.A10",      "Hbca30" = "L1MKK1901586.A11",
"Hbca31" = "L1MKK1901587.A12",      "Hbca32" = "L1MKK1901589.A14",
"Hbca33" = "L1MKK1901590.A15",      "Hbca34" = "L1MKK1901591.A16",
"Hbca35" = "L1MKK1901592.A17",      "Hbca36" = "L1MKK1901593.A18",
"Hbca37" = "L1MKK1901594.A19",      "Hbca38" = "L1MKK1901595.A20",
"Hbca39" = "L1MKK1901596.A21",      "Hbca40" = "L1MKK1901597.A22",
"Hbca41" = "L1MKK1901598.A23",      "Hbca42" = "L1MKK1901599.A24",
"Hbca43" = "L1MKK1901600.A25",      "Hbca44" = "L1MKK1901601.A26",
"Hbca45" = "L1MKK1901602.A27",      "Hbca46" = "L1MKK1901603.A28",
"Hbca47" = "L1MKK1901604.A29",      "Hbca48" = "L1MKK1901605.A30"
)
# 2. Reverse the mapping for easy lookup
lookup <- setNames(names(id_map), id_map)
# 3. Rename the columns in all txi_run2 components
colnames(txi_run2$counts)    <- lookup[colnames(txi_run2$counts)]
colnames(txi_run2$abundance) <- lookup[colnames(txi_run2$abundance)]
colnames(txi_run2$length)    <- lookup[colnames(txi_run2$length)]
# 4. Reorder run2 to match the order of run1 (Hbca01, Hbca02...)
txi_run2$counts    <- txi_run2$counts[, colnames(txi_run1$counts)]
txi_run2$abundance <- txi_run2$abundance[, colnames(txi_run1$counts)]
txi_run2$length    <- txi_run2$length[, colnames(txi_run1$counts)]
print("Rename and Reorder Complete!")
if(!identical_structure) {
stop("The two TXI objects have different genes or samples!")
}
colnames(txi_run2$counts)
colnames(txi_run1$counts)
colnames(txi_run2$counts)
rownames(txi_run1$counts)
rownames(txi_run2$counts)
# Load the two objects
txi_run1 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/txi.rds")
txi_run2 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/salmon_old/old/txi.rds")
# 1. Create the mapping based on your image
# Left side is the "Hbca" name, right side is the ID found in run2
id_map <- c(
"Hbca01" = "L1MKI1007695.A1417245", "Hbca02" = "L1MKI1007696.A1359551",
"Hbca03" = "L1MKI1007697.A1179330", "Hbca04" = "L1MKI1007698.A1392252",
"Hbca05" = "L1MKI1007700.A1572261", "Hbca06" = "L1MKI1007701.A1615467",
"Hbca07" = "L1MKI1007710.A2514790", "Hbca08" = "L1MKI1007711.A2508198",
"Hbca09" = "L1MKI1007712.A2512442", "Hbca10" = "L1MKI1007713.A2510803",
"Hbca11" = "L1MKI1007714.A2524699", "Hbca12" = "L1MKI1007716.A2507863",
"Hbca13" = "L1MKI1007717.A2510884", "Hbca14" = "L1MKI1007718.A2508524",
"Hbca15" = "L1MKI1007719.A2511623", "Hbca16" = "L1MKI1007720.A2510947",
"Hbca17" = "L1MKI1007721.A2507839", "Hbca18" = "L1MKI1007722.A2514836",
"Hbca19" = "L1MKI1007725.A2515727", "Hbca20" = "L1MKI1007726.A2510069",
"Hbca21" = "L1MKI1007727.A2515099", "Hbca22" = "L1MKI1007728.A2527491",
"Hbca23" = "L1MKI1007729.A2507738", "Hbca24" = "L1MKK1901578.A3",
"Hbca25" = "L1MKK1901580.A5",       "Hbca26" = "L1MKK1901582.A7",
"Hbca27" = "L1MKK1901583.A8",       "Hbca28" = "L1MKK1901584.A9",
"Hbca29" = "L1MKK1901585.A10",      "Hbca30" = "L1MKK1901586.A11",
"Hbca31" = "L1MKK1901587.A12",      "Hbca32" = "L1MKK1901589.A14",
"Hbca33" = "L1MKK1901590.A15",      "Hbca34" = "L1MKK1901591.A16",
"Hbca35" = "L1MKK1901592.A17",      "Hbca36" = "L1MKK1901593.A18",
"Hbca37" = "L1MKK1901594.A19",      "Hbca38" = "L1MKK1901595.A20",
"Hbca39" = "L1MKK1901596.A21",      "Hbca40" = "L1MKK1901597.A22",
"Hbca41" = "L1MKK1901598.A23",      "Hbca42" = "L1MKK1901599.A24",
"Hbca43" = "L1MKK1901600.A25",      "Hbca44" = "L1MKK1901601.A26",
"Hbca45" = "L1MKK1901602.A27",      "Hbca46" = "L1MKK1901603.A28",
"Hbca47" = "L1MKK1901604.A29",      "Hbca48" = "L1MKK1901605.A30"
)
# 2. Reverse the mapping for easy lookup
lookup <- setNames(names(id_map), id_map)
# 3. Rename the columns in all txi_run2 components
colnames(txi_run2$counts)    <- lookup[colnames(txi_run2$counts)]
colnames(txi_run2$abundance) <- lookup[colnames(txi_run2$abundance)]
colnames(txi_run2$length)    <- lookup[colnames(txi_run2$length)]
# 4. Reorder run2 to match the order of run1 (Hbca01, Hbca02...)
txi_run2$counts    <- txi_run2$counts[, colnames(txi_run1$counts)]
txi_run2$abundance <- txi_run2$abundance[, colnames(txi_run1$counts)]
txi_run2$length    <- txi_run2$length[, colnames(txi_run1$counts)]
print("Rename and Reorder Complete!")
# 1. Check if the Gene IDs and Samples match exactly
identical_structure <- identical(rownames(txi_run1$counts), rownames(txi_run2$counts)) &&
identical(colnames(txi_run1$counts), colnames(txi_run2$counts))
if(!identical_structure) {
stop("The two TXI objects have different genes or samples!")
}
identical_structure
# 2. Calculate the correlation (should be > 0.9999)
# We use 'sapply' to check every sample
correlations <- sapply(1:ncol(txi_run1$counts), function(i) {
cor(txi_run1$counts[,i], txi_run2$counts[,i])
})
# 3. Find the maximum absolute difference in counts
max_diff <- max(abs(txi_run1$counts - txi_run2$counts))
# Print results
cat("--- TXI Comparison Results ---\n")
cat("Mean Correlation: ", mean(correlations), "\n")
cat("Minimum Correlation: ", min(correlations), "\n")
cat("Maximum Count Difference: ", max_diff, "\n")
# Sort both by Gene ID (rownames) to ensure they align perfectly
txi_run1_sorted <- txi_run1$counts[order(rownames(txi_run1$counts)), ]
txi_run2_sorted <- txi_run2$counts[order(rownames(txi_run2$counts)), ]
# Re-run the max difference check
new_max_diff <- max(abs(txi_run1_sorted - txi_run2_sorted))
print(paste("New Max Difference:", new_max_diff))
proj <- "Xinyi"
species <- "Homo sapiens"
contrasts <- c()
parent_dir <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past"
gmt_dir <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Documents/GitHub/R-Scripts/GSEA_genesets"
# DESeq2 overrides
deseq2.override <- list(
contrasts     = contrasts,
#design        = "Comparisons",            # DESeq2 design formula or column name
#lfc.cutoff    = 0,                        # Log fold change cutoff for significance
#padj.cutoff   = 0.1,                      # Adjusted p-value cutoff for significance
batch.correct = FALSE                     # Boolean, whether to apply batch correction
)
# Heatmap overrides
heatmap.override <- list(
#force.log        = TRUE,                  # Force log transformation
col.ann          = NULL,                  # Column annotation
#row.ann          = NULL,                  # Row annotation
#col.gaps         = NULL,                  # Column gaps
#row.gaps         = NULL,                  # Row gaps
col.cluster      = "all",                 # Column clustering
#row.cluster      = "all",                 # Row clustering
#palette         = "rdbu",                # Heatmap palette
#ann.palette     = "discrete",            # Annotation palette
#border.color    = NA,                    # Cell border color
#show.expr.legend = TRUE,                  # Show expression legend
#title           = "",                    # Heatmap title
format           = "tiff"                 # Output file format
)
# Volcano plot overrides
volcano.override <- list(
#lfc.cutoff  = 0.58,                         # Minimum log2 fold-change to highlight
#padj.cutoff = 0.05,                      # Adjusted p-value cutoff
#color       = "vrds",                    # Color palette
#label.genes = c()                         # Genes to label on the plot
)
salmon_dir <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/salmon"
proj_dir <- "C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi"
txi <- prep_txi(salmon_dir = salmon_dir,
species    = "Homo sapiens",
db_version = "113",
filename   = NULL,
output_dir = proj_dir)
metadata <- openxlsx::read.xlsx(file.path(proj_dir, "Xinyi_Metadata.xlsx"))
raw_counts_mat <- NULL
design      <- "Batch"
deseq2_data <- prepare_deseq2_input(expr_mat = raw_counts_mat,
txi      = txi,
metadata = metadata,
design   = design)
dds <- DESeqDataSetFromTximport(txi     = deseq2_data$txi,
colData = deseq2_data$metadata,
design  = ~ Batch)
dds <- DESeq(dds)
vsd <- vst(dds, blind = FALSE)
vsd_mat <- assay(vsd)
library(limma)
vsd_batch_corrected <- removeBatchEffect(vsd_mat,
batch = deseq2_data$metadata$Batch)
ann_list <- get_annotations()
vsd_batch_corrected <- vsd_batch_corrected %>%
as.data.frame() %>%
tibble::rownames_to_column("ID") %>%
add_annotation(ann_list = ann_list) %>%
dplyr::group_by(SYMBOL) %>%
dplyr::summarize(across(.cols = where(is.numeric), .fns = mean, na.rm = TRUE), .groups = "drop") %>%
tibble::column_to_rownames("SYMBOL") %>%
as.matrix()
cl <- getConsensusClass(x = vsd_batch_corrected, gene_id = c("hgnc_symbol"))
metadata_col <- dplyr::left_join(x = metadata %>% dplyr::mutate(Sample_ID = make.names(Sample_ID)),
y = cl %>% tibble::rownames_to_column("Sample_ID"),
by = c("Sample_ID" = "Sample_ID"))
df_c3 <- data.frame(SYMBOL = c3_genes, Category = "C3")
df_scaffold <- data.frame(SYMBOL = scaffold_genes, Category = "Scaffold")
df_cam <- data.frame(SYMBOL = cam_genes, Category = "CAM")
df_ne <- data.frame(SYMBOL = ne_genes, Category = "Neuroendocrine")
metadata_row <- rbind(df_c3, df_scaffold, df_cam, df_ne) %>%
dplyr::distinct(SYMBOL, .keep_all = TRUE)
mat <- vsd_batch_corrected[rownames(vsd_batch_corrected) %in% c(c3_genes, scaffold_genes, cam_genes, ne_genes), ]
ph <- plot_heatmap(expr_mat            = mat,
label_genes         =  metadata_row$SYMBOL,
filename            = "Xinyi",
output_dir          = proj_dir,
metadata_col        = metadata_col,
metadata_row        = metadata_row,
col_annotations     = c("consensusClass"),
row_annotations     = c("Category"),
col_gap_by          = c("consensusClass"),
row_gap_by          = c("Category"),
col_cluster_by      = c("consensusClass"),
row_cluster_by      = c("Category"),
plot_title          = NULL,
heatmap_palette     = "rdbu",
annotation_palette  = "discrete",
border_color        = NA,
force_log           = FALSE,
show_expr_legend    = TRUE,
save_plot           = TRUE,
save_matrix         = TRUE)
# Save the results
wb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wb, sheetName = "Classification")
openxlsx::writeData(wb, sheet = "Classification", x = metadata_col)
openxlsx::saveWorkbook(wb, file = file.path(proj_dir,"Classification.xlsx"), overwrite = TRUE)
wb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wb, sheetName = "VST counts")
openxlsx::writeData(wb, sheet = "VST counts", x = vsd_batch_corrected, rowNames = TRUE)
openxlsx::saveWorkbook(wb, file = file.path(proj_dir,"Batch corrected VST counts.xlsx"), overwrite = TRUE)
txi_run1 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/txi.rds")
txi_run2 <- readRDS("C:/Users/kailasamms/OneDrive - Cedars-Sinai Health System/Desktop/Collaboration projects data/Past/Xinyi/salmon_old/old/txi.rds")
# 1. Check if the Gene IDs and Samples match exactly
identical_structure <- identical(rownames(txi_run1$counts), rownames(txi_run2$counts)) &&
identical(colnames(txi_run1$counts), colnames(txi_run2$counts))
if(!identical_structure) {
stop("The two TXI objects have different genes or samples!")
}
# 2. Calculate the correlation (should be > 0.9999)
# We use 'sapply' to check every sample
correlations <- sapply(1:ncol(txi_run1$counts), function(i) {
cor(txi_run1$counts[,i], txi_run2$counts[,i])
})
# 3. Find the maximum absolute difference in counts
max_diff <- max(abs(txi_run1$counts - txi_run2$counts))
# Print results
cat("--- TXI Comparison Results ---\n")
cat("Mean Correlation: ", mean(correlations), "\n")
cat("Minimum Correlation: ", min(correlations), "\n")
cat("Maximum Count Difference: ", max_diff, "\n")
# Sort both by Gene ID (rownames) to ensure they align perfectly
txi_run1_sorted <- txi_run1$counts[order(rownames(txi_run1$counts)), ]
txi_run2_sorted <- txi_run2$counts[order(rownames(txi_run2$counts)), ]
# Re-run the max difference check
new_max_diff <- max(abs(txi_run1_sorted - txi_run2_sorted))
print(paste("New Max Difference:", new_max_diff))
# 1. Extract total mapped counts for each run
# colSums calculates the total quantified fragments per sample
run1_totals <- colSums(txi_run1$counts)
run2_totals <- colSums(txi_run2$counts)
comparison_df <- data.frame(
Sample = names(run1_totals),
Run1_Total_Reads = run1_totals,
Run2_Total_Reads = run2_totals[names(run1_totals)] # Match by sample name
)
View(comparison_df)
print(comparison_df)
comparison_df <- data.frame(
Sample = names(run1_totals),
Run1_Total_Reads = run1_totals,
Run2_Total_Reads = run2_totals[names(run1_totals)],
Diff = Run1_Total_Reads - Run2_Total_Reads# Match by sample name
)
comparison_df <- data.frame(
Sample = names(run1_totals),
Run1_Total_Reads = run1_totals,
Run2_Total_Reads = run2_totals[names(run1_totals)],
Diff = run1_totals - run2_totals[names(run1_totals)]# Match by sample name
)
print(comparison_df)
